SignalNow Azure Functions Overview
===========================================================

SignalNow uses 3 Azure Functions for negotiating a connection, getting a message token, and actually sending messages. 

1.  [**Negotiate**](#Negotiate)

2.  [**GetMessageToken**](#GetMessageToken)

3.  [**Message**](#GetMessageToken)

There is one more function - **GenerateSignalNowKey**, which is used for generating keys for [SignalNowKey Authentication](SignalNowKey%20Authentication.md). It's an admin-only function. 
 
## <a name="Negotiate"></a>Negotiate

Negotiate function (HTTP call) checks if a provided user is a member of a provided team, then generates a client token for SignalR, and an optional TURN authentication token.

*Function input (all - request headers):*

-   **authServiceName** - Authentication and people graph service, e.g. 'graph.microsoft.com' or 'github.com' or  '[signalnowkey](SignalNowKey%20Authentication.md)'.

-   **companyName** - Company name, company id or tenant id, e.g. 'microsoft' or '72f988bf-86f1-41af-91ab-2d7cd011db47'. It must be a tenant id for Microsoft Graph, an organization name for GitHub 

-   **teamName** - Team name or team id, e.g. 'MyTeam' or '11244a09-ff97-4178-9635-4ca38dfb1015'. May also be a 'room name' for room-oriented scenarios. It must be a group id for Microsoft Graph, team name for GitHub. If you don't want to limit it to a specific group, provide **'*'** (a star) instead. 

-   **userName** - User name, e.g. 'vlad' or 'vlad@microsoft.com'. It must be user's principal name (userPrincipalName) for Microsoft Graph, user name for GitHub 

-   **deviceId** - Device id (MAC address or a GUID expected)

-   **authServiceToken** - bearer token for authentication and people graph
    service (in case of [SignalNowKey](SignalNowKey authentication.md) authentication, a key generated by **GenerateSignalNowKey**

    **If Azure Active Directory used, the authenticating app should have permissions sufficient for calling [checkMemberGroups API](https://docs.microsoft.com/en-us/graph/api/user-checkmembergroups?view=graph-rest-beta) (as of today, it is Directory.Read.All).**


*Step 1.*

The function uses authServiceToken for performing 2 checks:

1.  **authServiceToken** belongs to **userName**.

2.  **userName** is a member of team/group identified by **companyName** and
    **teamName** (based on Microsoft Graph).

If checks are not passed, the function fails.
 

*Step 2.*

The function creates user id as:

**deviceId\|userName+authServiceName/companyName/teamName**

*SignalR requires user and group names to be alphanumeric with underscore
allowed, starting with a alphabetic character. That's why real user id used with
SignalR is HMAC-MD5-hash of user id with 'u_' prefix ("u_" + HMACMD5(userId)).*

 

*Step 3.*

[optional, if enabled in app settings] Generates [TURN REST
Authentication](TURN%20REST%20Authentication.md)
token.

 

*Function output (as a simple JSON array, ["{user id}", "{client token}",
"client URL", "serverUnixEpochTime", "TURN auth token json"]):*

-   **user id**

-   **JWT client token** *for SignalR* (for receiving messages)

-   **SignalR client URL**

-   **Server time** (server UTC time in [Unix
    Epoch](https://en.wikipedia.org/wiki/Unix_time) seconds number as string)

-   **TURN Authentication token** (see [TURN REST
    Authentication](TURN%20REST%20Authentication.md))

 

As SignalR REST API requires, **signing key** for JWT token is **SignalR Access
token**.

**Claims** include HMACMD5 hash of **user id** (hash has "u_" prefix) as
*ClaimTypes.NameIdentifier*, and **user id** as *ClaimTypes.GivenName.*

JWT Token **audience** is **{endpoint}/client/?hub={hubName}** (endpoint is
SignaR service's address, hubName is a custom name). This is for receiving
messages only.

Such JWT token allows the client to receive messages, but the client must use it
for **Message** function as well.

## <a name="GetMessageToken"></a>GetMessageToken

GetMessageToken function returns a JWT token for calling Message function, then adds the user to a few important SignalR groups.

It generates a token based on a SignalR client token or previously received message token.

The goal of this function is to be able to renew JWT tokens for sending messages
while maintaining RECEIVE-only connection to SignalR. A client can keep an
existing connection even if its authorization token is expired, but it needs a
valid unexpired token to be able to call **Message**.

 
*Function input (request header):*

-   **authToken** - a valid unexpired JWT token signed with SignalR's secret key
    (either SignalR client token or a token previously received from
    GetMessageToken)

*Step 1.*

Extracts Base64-encoded user id from the token. Decodes user id.

*Step 2.*

Generates a new JWT token with user id using SignalR secret key.

*Step 3.*

The function adds user id to the following SignalR groups:

-   **userName+authServiceName/companyName/teamName** - user *userName* on all
    devices

-   **deviceId:authServiceName/companyName/teamName** - any team member on device with *deviceId* (for physical proximity scenarios)

-   **authServiceName/companyName/teamName** - the entire *teamName* team

 

*SignalR requires user and group names to be alphanumeric with underscore
allowed, starting with a alphabetic character. That's why real names used with
HMAC-MD5 hashes of those names 'u_' prefix ("u_" + HMACMD5(group)).*

*Function output (plain string):*

-   **a JWT client token** for calling **Message** function (includes user id)

If a token expires, client has to call Negotiate again and reconnect to SignalR. 

## <a name="Message"></a>Message

Message function checks if current user can send message to provided receiver.
If passes the check, **sends provided message**.

*Function input:*

-   **authToken** (request header) - an unexpired valid JWT message token (get
    it using **GetMessageToken**, make sure you renew the token by calling GetMessageToken before the token
    expires)

-   **sendTo** (request header) - message receiver's name (a user or a group)

-   **userOrGroup** (request header) - receiver type, "*user*" for a single
    user, "*group*" for a group

-   [messageType](Signaling%20Messages.md) (request header) - message type string

-   **payload** (request header **or request content**) - text message to be
    sent

 

*Step1.*

Check if JWT token is valid (performed by JWT classes).

 

*Step 2.*

heck if the user can send messages to sendTo. **User id** is extracted from JWT
token (*ClaimTypes.NameIdentifier* claim value).

The rule is that they must be from the same team.

*Examples*:

'00-14-22-01-23-44\|myusername+github.com/mycompany/myteam' **can** send to
'github.com/mycompany/myteam' (send to the entire team)

'00-14-22-01-23-44\|myusername+github.com/mycompany/myteam' **can** send to
'anotheruser+github.com/mycompany/myteam' (sends to a user on all devices)

'00-14-22-01-23-44\|myusername+github.com/mycompany/myteam' **can** send to
'00-14-66-01-55-77\|anotheruser+github.com/mycompany/myteam' (send to a user, on
a single device)

'00-14-22-01-23-44\|myusername+github.com/mycompany/myteam' **can** send to
'00-14-66-01-55-77:github.com/mycompany/myteam' (sends to any user on a device)

'00-14-22-01-23-44\|myusername+github.com/mycompany/myteam' **can NOT** send to
'anotheruser+github.com/mycompany/**anotherteam**' (because another team)

*Step 3.*

Sends message with payload to the receiver using SignalR.

Every message has sender's **user id** and **messageType** as first 2 fields
(see [Signaling Messages](Signaling%20Messages.md)).

 
*Function output:*

-   HTTP error code only

## Configuration variables

*Provided HubName and AuthTokenLifetimeMinutes values are for reference only.
AzureSignalRConnectionString must be your Azure SignalR connection string.*

* "AzureSignalRConnectionString" (**required**):
"Endpoint=https://\<your_signalr_service\>.service.signalr.net;AccessKey=\<access_key\>;Version=1.0;", (Azure SignalR connection string)

* "HubName": "SignalNow",

* "AuthTokenLifetimeMinutes": "60", (all authorization tokens lifetime in minutes)

* "SignalNowKey": "", (a security key for SignalNowKey authorization)

* "TURNAuthorizationKey": "", (TURN static auth secret)

* "TURNServersList": "" (comma-separated list of TRUN URIs, e.g. turn:1.2.3.4:9991?transport=udp,turn:1.2.3.4:9992?transport=tcp)


## [SignalNow Service Architecture](Architecture.md)